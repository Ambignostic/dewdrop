<?php

/* @var $view \Dewdrop\View\View */
$view = $this;
?>

<?php
if ($this->bulkActionFailureMessage) {
    printf(
        '<div class="alert alert-danger">%s</div>',
        $this->escapeHtml($this->bulkActionFailureMessage)
    );
}

echo $this->adminComponentNav(
    $this->component,
    [
        'createUrl'              => $this->createUrl,
        'deletedRecordsModifier' => $this->deletedRecordsModifier
    ]
);

echo $this->bootstrapFilterForm()->adminPanel($this->component);
?>

<?php
echo $this->partial(
    'index-keyboard-shortcuts.phtml',
    array(
        'componentTitle' => $this->component->getTitle(),
        'singularTitle'  => $this->singularTitle
    )
);

// Start table

$renderer = $this->tableCellRenderer();
$fields   = $this->fields->getVisibleFields(array($this->groupingFilter, $this->visibilityFilter));
$pkey     = $this->listing->getPrimaryKey()->getName();

$rowActionArgs = array(
    'renderer'  => $renderer,
    'field'     => $fields->getIterator()->current(),
    'title'     => $this->singularTitle,
    'urlFields' => $pkey
);

if ($this->permissions->can('edit')) {
    $rowActionArgs['edit'] = $this->adminUrl('edit', array($pkey => '%s'));
}

if ($this->permissions->can('view')) {
    $rowActionArgs['view'] = $this->adminUrl('view', array($pkey => '%s'));
}

$this->bootstrapRowActions()->assignCallback($rowActionArgs);

$selectFilter  = $this->listing->getSelectModifierByName('SelectFilter');

if ($this->isSortable) {
    $sortField = $this->component->getSortField();

    $this->tableSortHandle()->assignToField(
        $sortField,
        $renderer,
        $this->listing->getPrimaryKey()->getName()
    );

    echo $this->tableSortHandle()->open($this->adminUrl('sort-listing'));
}

if ($this->bulkActions) {
    $fields->prepend($this->bulkActionCheckboxField($this->bulkActions, $renderer));

    echo $this->bulkActionForm()->open();
}

if ($this->deletedRecordsModifier && $this->deletedRecordsModifier->isShowingDeletedRecords()) {
    printf(
        '<div class="alert alert-warning">Currently displaying deleted %s.</div>',
        $this->escapeHtml($this->pluralTitle)
    );
}

if (0 === $this->totalRowCount && $selectFilter->hasFilters()) {
    printf(
        '<div class="alert alert-warning">No %s found matching your filters.  Please try again.</div>',
        $this->escapeHtml(strtolower($this->pluralTitle))
    );
} else {
    /** @var \Dewdrop\View\Helper\BootstrapTable $tableHelper */
    $tableHelper = $this->component->isDataTablesEnabled() ? 'bootstrapDataTableTable' : 'bootstrapTable';

    echo $this->$tableHelper(
        $fields,
        $this->$tableHelper()->getData($this->listing, $this->component, $fields),
        $renderer,
        $this->listing->getSelectModifierByName('SelectSort')
    );
}

// End table

if ($this->isSortable) {
    echo $this->tableSortHandle()->close();
}

$totalRowCount = $this->listing->getTotalRowCount();

/* @var $paginationHelper \Dewdrop\Fields\Helper\SelectPaginate */
$paginationHelper = $this->listing->getSelectModifierByName('SelectPaginate');

if ($this->bulkActions) {
    echo $this->bulkActionForm()->close(
        $this->bulkActions,
        $totalRowCount,
        ($paginationHelper->isEnabled() ? $paginationHelper->getPageSize() : $totalRowCount),
        $this->pluralTitle
    );
}

$paginationTitle = (1 === $totalRowCount ? $this->singularTitle : $this->pluralTitle);

if (!$this->component->isDataTablesEnabled()) {
    echo $this->pagination(
        $totalRowCount,
        ($paginationHelper->isEnabled() ? $paginationHelper->getPageSize() : $totalRowCount),
        $paginationHelper->getPage(),
        $paginationTitle
    );
}

echo $this->bootstrapColumnsModal(
    $this->fields->getVisibleFields($this->groupingFilter),
    $this->fields->getVisibleFields($this->visibilityFilter),
    $this->adminUrl('adjust-visibility'),
    $this->visibilityFilter->canBeFilteredByUser()
);

$fields = $this->fields->getVisibleFields([$this->groupingFilter, $this->visibilityFilter]);

if ($this->component->isDataTablesEnabled()) :
?>
    <script type="text/javascript">
        var INDEX_TABLE;
        var INDEX_TABLE_OPTIONS = <?php echo $this->bootstrapDataTableTable()->getDataTableOptionsJson($fields, $this->listing, $this->datatables(), $paginationTitle); ?>;
    </script>
<?php
    $this->headLink()->appendStylesheet($this->bowerUrl('datatables.net-bs/css/dataTables.bootstrap.min.css'));
    $this->headScript()->appendFile($this->bowerUrl('/dewdrop/www/js/main-table.js'));
endif;

$this->headLink()->appendStylesheet($this->bowerUrl('/dewdrop/www/css/table.css'));
$this->headScript()->appendFile($this->bowerUrl('/dewdrop/www/js/listing-keyboard-shortcuts.js'));
?>
